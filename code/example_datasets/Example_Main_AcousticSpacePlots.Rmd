---
title: <center style="font-size:30px;font-style:normal;color:#0E0E7D;">Acoustic space plots for main figures</center>
author: |
  <br />
  <center style="font-style:normal;">
  <a style="font-size:22px;color:#337ab7;text-decoration: underline;"href="https://smith-vidaurrelab.github.io/">Grace Smith-Vidaurre</a><sup><span style="font-size:12px;color:black;text-decoration:none!important;">1-3*</span></sup> 
  <br />
  <br />
  <center style="font-size:18px;font-style:normal;color:black;"><sup><span style="font-size:12px;color:black;">1</span></sup>Department of Integrative Biology, Michigan State University</center>
  <center style="font-size:18px;font-style:normal;color:black;"><sup><span style="font-size:12px;color:black;">2</span></sup>Department of Computational Mathematics, Science, and Engineering, Michigan State University</center>
  <center style="font-size:18px;font-style:normal;color:black;"><sup><span style="font-size:12px;color:black;">3</span></sup>Ecology, Evolution, and Behavior Program, Michigan State University</center>
  <br />
  <center style="font-size:18px;"><sup style="font-size:12px;">*</sup>Corresponding author (smithvid@msu.edu)</center>
date: <center style=font-size:22px;font-style:normal;>`r format(Sys.time(), '%d %B %Y')`</center>
  <br />
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
---

<style type="text/css">
body{
  font-family: Arial;
  font-size: 14pt;
}
h1{
  font-size: 22pt;
}

h2{
  font-size: 18pt;
}

h3{
  font-size: 16pt;
}
</style>

**Purpose**: Here we build acoustic space plots for main figures. Acoustic space plots are generated using multidimensional scaling coordinates from spectrographic cross-correlation and edit distance measurements. The plots below will display a subsample of groups for each of the group membership and individual identity call datasets that we show in the first two main figures. The supplementary figures will display all groups in each synthetic dataset.

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE, messsage = FALSE)

```

Load packages and set paths.
```{r}

# Clean the global environment
rm(list = ls())

# Specify the required packages
X <- c("devtools", "dplyr", "stringdist", "tidyverse", "ggplot2", "apcluster", "soundgen", "parallel", "stringr", "data.table", "tuneR", "pbapply", "warbleR", "paletteer")

# Install the packages in X if not already installed
is_installed <- function(p) is.element(p, installed.packages()[,1])

invisible(lapply(1:length(X), function(x){
  if(!is_installed(X[x])){
    install.packages(X[x], repos = "http://lib.stat.cmu.edu/R/CRAN")
  }
}))

# Set cores for parallel processing
cores <- parallel::detectCores() - 4
cores

```

```{r load packages, eval = FALSE}

# Load all of the packages specified above
invisible(lapply(X, library, character.only = TRUE, verbose = FALSE))

```

```{r load packages in background, include = FALSE}

# The only solution right now to avoid having a whole bunch of verbose output printed from the chunk above
# Load all of the packages specified above
invisible(lapply(X, library, character.only = TRUE, verbose = FALSE))

```

Initialize working directories for data on your local machine.
```{r}

# Initialize a base path (this will need to be different per user)
# path <- "/Users/gracesmith-vidaurre/Desktop" # Grace's path
path <- "/Users/gsvidaurre/Desktop/" # Grace's path

# Initialize a path for the local GitHub repo for this manuscript, for saving final figures here
# git_path <- "C:/Users/britt/Documents/GitHub" # Britt's path
git_path <- file.path(path, "GitHub_repos") # Grace's path

# Initialize the directory for analysis on your local computer
analysis_dir <- "paRsynth_methods_synthetic_dataset"

# Combine the base path and the data directory into a single path
analysis_path <- file.path(path, analysis_dir)

# Create the data directory if it doesn't already exist on your computer
if(!dir.exists(analysis_path)){ 
  dir.create(analysis_path)
}

# Specify a folder inside the analysis directory where images for figures will be written out/read in
figures_dir <- "paRsynth-methods-paper/figures"

# Combine the base path, the analysis directory, and the data directory into a single path
figures_path <- file.path(git_path, figures_dir)

```

Read in the synthetic call metadata, and MDS coordinates. Set cores for parallel processing.
```{r eval = FALSE}

synthetic_call_metadata <- read.csv(file.path(analysis_path, "synthetic_call_metadata.csv"))
glimpse(synthetic_call_metadata)

mds_coords <- read.csv(file.path(analysis_path, "MDS_coordinates.csv"))
glimpse(mds_coords)

```

```{r echo = FALSE, eval = TRUE}

# Read in the necessary spreadsheets with full paths for RMarkdown knitting
synthetic_call_metadata <- read.csv("/Users/gsvidaurre/Desktop/paRsynth_methods_synthetic_dataset/synthetic_call_metadata.csv")
glimpse(synthetic_call_metadata)

mds_coords <- read.csv("/Users/gsvidaurre/Desktop/paRsynth_methods_synthetic_dataset/MDS_coordinates.csv")
glimpse(mds_coords)

```

## Step 1: Generate low-dimensional acoustic space plots for the group membership dataset: 

Create two plots (SPCC and edit distance) with convex hull polygons by group. These plots should be organized with edit distance on the top and SPCC on the bottom, so the edit distance plot will have a legend. These plots will be combined with a small collection of spectrograms in one main figure.

Start with aesthetics.
```{r}

# Get colors for groups from the same palette used for spectrograms in lexicons
cols <- paletteer::paletteer_d("nationalparkcolors::Arches")
cols

# Combine MDS results from the SPCC and edit distance pipelines
mds_spcc_grp <- mds_coords %>%
  # Filter by the group membership calls and MDS coordinates from SPCC
  dplyr::filter(
    dataset == "Group Membership", method == "SPCC"
  ) %>%
  # Convert strings to factors for plotting
  dplyr::mutate(
    group_ID = factor(group_ID),
    individual_ID = factor(individual_ID)
  )

glimpse(mds_spcc_grp)

mds_edit_grp <- mds_coords %>%
  # Filter by the group membership calls and MDS coordinates from SPCC
  dplyr::filter(
    dataset == "Group Membership", method == "edit"
  ) %>% 
  dplyr::mutate(
    group_ID = factor(group_ID),
    individual_ID = factor(individual_ID)
  )

glimpse(mds_edit_grp)

levels(mds_spcc_grp$group_ID)
levels(mds_spcc_grp$individual_ID)

# All colors by group (five)
cols_grp <- cols[1:length(levels(mds_spcc_grp$group))]
cols_grp

# All shapes by individual within groups. See ?points()
shps <- c(7, 8, 10, 4, 16, 17, 21, 23, 24, 6)

# Then filter colors for Groups 2 and 3 that will be used in the group membership plots below. Group 2 should be orange and Group 3 should be brown (dark purple or red). 
cols_grp_filt <- cols_grp[grep(paste(paste("^", c("2", "3"), "$", sep = ""), collapse = "|"), levels(mds_spcc_grp$group_ID))]
cols_grp_filt

```

Create the group membership plots for edit distance.
```{r}

# Filter the MDS coordinates by the two groups that will be shown in these plots
mds_edit_grp_filt <- mds_edit_grp %>% 
  dplyr::filter(group_ID %in% c(2, 3))

glimpse(mds_edit_grp_filt)

# Convex hull polygons per group
hulls <- plyr::ddply(mds_edit_grp_filt, "group_ID", function(x){
  x[chull(x$X, x$Y), ]
})

glimpse(hulls)

mds_edit_grp_filt %>%
  ggplot(aes(x = X, y = Y)) + 
  geom_polygon(data = hulls, aes(x = X, y = Y, fill = group_ID), alpha = 0.4, linewidth = 0.2, show.legend = FALSE) +
  geom_point(aes(fill = group_ID, color = group_ID, shape = individual_ID), size = 1.5, stroke = 0.5) +
  scale_shape_manual(values = shps) +
  scale_color_manual(values = cols_grp_filt) +
  scale_fill_manual(values = cols_grp_filt) +
  xlab("") + ylab("") + 
  # Below is the legend for individual labels only (for figure creation)
  guides(color = "none", shape = guide_legend(title = "Individual", nrow = 1, override.aes = list(size = 2)), fill = "none") +
  # Below is the legend with Group and Individual labels
  guides(color = guide_legend(title = "Group", override.aes = list(size = 3), order = 1), shape = guide_legend(title = "Individual", nrow = 1), fill = guide_legend(title = "Group", order = 1)) +
  # Uncomment this line to turn off the legend
  # guides(color = "none", shape = "none", fill = "none") +
  # Specify the x and y-axis limits and breaks. Make sure that each label retains two decimal places even when there is a trailing zero
  scale_x_continuous(limits = c(-4.75, -1.8), breaks = seq(-4.75, -1.75, 0.5), labels = sprintf("%.2f", round(seq(-4.75, -1.75, 0.5), 2))) +
  scale_y_continuous(limits = c(-4.5, 4), breaks = seq(-4, 4, 1), labels = sprintf("%.2f", round(seq(-4, 4, 1), 2))) +
  theme_bw() +
  theme(
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 9),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_line(linewidth = 0.25),
    legend.position = "top",
    legend.key.spacing = unit(0.025, "lines"),
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 9),
    # margin() arguments: top, right, bottom, left
    plot.margin = margin(0, 3, -3, -3, unit = "pt"),
    legend.margin = margin(2, -3, -5, -3, unit = "pt")
  )

```

Save edit distance plot.
```{r eval = FALSE}

# Save this plot as an image file
# This image size (and font sizes or other aesthetics above) should be iteratively updated to fit a composite figure of multiple acoustic space plots created in other software
ggsave(filename = file.path(figures_path, "Fig_2", "Main_AcousticSpace_edit_GroupMembership_GroupPolygons_legend.tiff"), width = 4.5, height = 2.4, units = "in", dpi = 300)

# Version without legend for figure creation purposes
ggsave(filename = file.path(figures_path, "Fig_2", "Main_AcousticSpace_edit_GroupMembership_GroupPolygons.tiff"), width = 3.75, height = 2.6, units = "in", dpi = 300)

```

Create the group membership plots for SPCC.
```{r}

# Filter the MDS coordinates by the two groups that will be shown in these plots
mds_spcc_grp_filt <- mds_spcc_grp %>% 
  dplyr::filter(group_ID %in% c(2, 3))

glimpse(mds_spcc_grp_filt)

# Convex hull polygons per group
hulls <- plyr::ddply(mds_spcc_grp_filt, "group_ID", function(x){
  x[chull(x$X, x$Y), ]
})

# glimpse(hulls)

mds_spcc_grp_filt %>%
  ggplot(aes(x = X, y = Y)) + 
  geom_polygon(data = hulls, aes(x = X, y = Y, fill = group_ID), alpha = 0.4, linewidth = 0.2, show.legend = FALSE) +
  geom_point(aes(fill = group_ID, color = group_ID, shape = individual_ID), size = 1.5, stroke = 0.5) +
  scale_shape_manual(values = shps) +
  scale_color_manual(values = cols_grp_filt) +
  scale_fill_manual(values = cols_grp_filt) +
  xlab("") + ylab("") + 
  # Below is the legend with Group and Individual labels
  guides(color = guide_legend(title = "Group", override.aes = list(size = 3), order = 1), shape = guide_legend(title = "Individual", nrow = 1), fill = guide_legend(title = "Group", order = 1)) +
  # Uncomment this line to turn off the legend
  # guides(color = "none", shape = "none", fill = "none") +
  # Specify the x and y-axis limits and breaks. Make sure that each label retains two decimal places even when there is a trailing zero
  scale_x_continuous(limits = c(-0.35, 0), breaks = seq(-0.35, 0, 0.05), labels = sprintf("%.2f", round(seq(-0.35, 0, 0.05), 2))) +
  scale_y_continuous(limits = c(-0.35, 0.25), breaks = seq(-0.35, 0.25, 0.1), labels = sprintf("%.2f", round(seq(-0.35, 0.25, 0.1), 2))) +
  theme_bw() +
  theme(
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 9),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_line(linewidth = 0.25),
    legend.position = "top",
    legend.key.spacing = unit(0.2, "lines"),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 10),
    # margin() arguments: top, right, bottom, left
    plot.margin = margin(0, 3, -3, -3, unit = "pt"),
    legend.margin = margin(2, -3, -5, -3, unit = "pt")
  )

```

Save SPCC plot.
```{r eval = FALSE}

# Save this plot as an image file
# This image size (and font sizes or other aesthetics above) should be iteratively updated to fit a composite figure of multiple acoustic space plots created in other software
ggsave(filename = file.path(figures_path, "Fig_2", "Main_AcousticSpace_SPCC_GroupMembership_GroupPolygons.tiff"), width = 3.75, height = 2.6, units = "in", dpi = 300)

```

## Step 2: Generate low-dimensional acoustic space plots for the individual identity dataset

Create two plots (SPCC and edit distance) with convex hull polygons by individual. These plots should be organized with edit distance on the top and SPCC on the bottom, so the edit distance plot will have a legend. These plots will be combined with a small collection of spectrograms in one main figure.

Start with aesthetics.
```{r}

# Combine MDS results from the SPCC and edit distance pipelines
mds_spcc_ind <- mds_coords %>%
  # Filter by the group membership calls and MDS coordinates from SPCC
  dplyr::filter(
    dataset == "Individual Identity", method == "SPCC"
  ) %>%
  # Convert strings to factors for plotting
  dplyr::mutate(
    group_ID = factor(group_ID),
    individual_ID = factor(individual_ID),
    unique_individuals = factor(unique_individuals)
  )

glimpse(mds_spcc_ind)

mds_edit_ind <- mds_coords %>%
  # Filter by the group membership calls and MDS coordinates from SPCC
  dplyr::filter(
    dataset == "Individual Identity", method == "edit"
  ) %>%
  # Convert strings to factors for plotting
  dplyr::mutate(
    group_ID = factor(group_ID),
    individual_ID = factor(individual_ID),
    unique_individuals = factor(unique_individuals)
  )

glimpse(mds_edit_ind)

levels(mds_spcc_ind$group_ID)
levels(mds_spcc_ind$individual_ID)
levels(mds_spcc_ind$unique_individuals)

# Get colors for groups from the same palette used for spectrograms in lexicons
cols <- paletteer::paletteer_d("nationalparkcolors::Arches")
cols

# Colors by group
grp_cols <- cols[1:length(levels(mds_spcc_grp$group))]
grp_cols

# Then filter colors for Groups 1 and 2 that will be used in the group membership plots below. Group 1 should be light blue and Group 2 should be orange. 
cols_grp_filt <- cols_grp[grep(paste(paste("^", c("1", "2"), "$", sep = ""), collapse = "|"), levels(mds_spcc_grp$group_ID))]
cols_grp_filt

# Fills by unique individual in the two groups
fills <- rep(cols_grp_filt, each = length(levels(mds_spcc_ind$individual_ID)))
fills

# Shapes by individual within groups
shps <- c(7, 8, 10, 4, 16, 17, 21, 23, 24, 6)

```

Create the individual identity plots for edit distance.
```{r}

# Filter the MDS coordinates by the two groups that will be shown in these plots
mds_edit_ind_filt <- mds_edit_ind %>% 
  dplyr::filter(group_ID %in% c(1, 2))

glimpse(mds_edit_ind_filt)

hulls <- plyr::ddply(mds_edit_ind_filt, "unique_individuals", function(x){
  x[chull(x$X, x$Y), ]
})

# glimpse(hulls)

mds_edit_ind_filt %>%
  ggplot(aes(x = X, y = Y)) + 
  geom_polygon(data = hulls, aes(x = X, y = Y, fill = unique_individuals), alpha = 0.4, linewidth = 0.2, show.legend = FALSE) +
  geom_point(aes(color = group_ID, shape = individual_ID), size = 2, stroke = 0.5) +
  scale_shape_manual(values = shps) +
  scale_color_manual(values = cols_grp_filt) +
  scale_fill_manual(values = fills) +
  xlab("") + ylab("") + 
  guides(color = guide_legend(title = "Group", override.aes = list(size = 3), order = 1)) +
  # Uncomment this line to turn off the legend
  # guides(color = "none", shape = "none", fill = "none") +
  # Specify the x and y-axis limits and breaks. Make sure that each label retains two decimal places even when there is a trailing zero
  scale_x_continuous(limits = c(2.25, 4.5), breaks = seq(2.25, 4.5, 0.5), labels = sprintf("%.2f", round(seq(2.25, 4.5, 0.5), 2))) +
  scale_y_continuous(limits = c(-4.1, 4), breaks = seq(-4, 4, 1), labels = sprintf("%.2f", round(seq(-4, 4, 1), 2))) +
  theme_bw() +
  theme(
    legend.position = "top",
    legend.key.spacing = unit(0.2, "line"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 9),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_line(linewidth = 0.25),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 10),
    # margin() arguments: top, right, bottom, left
    plot.margin = margin(0, 3, -3, -3, unit = "pt"),
    legend.margin = margin(2, -3, -5, -3, unit = "pt")
  )

```

Save edit distance plots.
```{r eval = FALSE}

# Save this plot as an image file
# This image size (and font sizes or other aesthetics above) should be iteratively updated to fit a composite figure of multiple acoustic space plots created in other software
ggsave(filename = file.path(figures_path, "Fig_3", "Main_AcousticSpace_edit_IndividualIdentity_IndividualPolygons_legend.tiff"), width = 3.75, height = 2.6, units = "in", dpi = 300)

```

Create the individual identity plots for SPCC.
```{r}

# Filter the MDS coordinates by the two groups that will be shown in these plots
mds_spcc_ind_filt <- mds_spcc_ind %>% 
  dplyr::filter(group_ID %in% c(1, 2))

glimpse(mds_spcc_ind_filt)

hulls <- plyr::ddply(mds_spcc_ind_filt, "unique_individuals", function(x){
  x[chull(x$X, x$Y), ]
})

# glimpse(hulls)

mds_spcc_ind_filt %>%
  ggplot(aes(x = X, y = Y)) + 
  geom_polygon(data = hulls, aes(x = X, y = Y, fill = unique_individuals), alpha = 0.4, linewidth = 0.2, show.legend = FALSE) +
  geom_point(aes(color = group_ID, shape = individual_ID), size = 2, stroke = 0.5) +
  scale_shape_manual(values = shps) +
  scale_color_manual(values = cols_grp_filt) +
  scale_fill_manual(values = fills) +
  xlab("") + ylab("") + 
  guides(color = guide_legend(title = "Group", override.aes = list(size = 3), order = 1), shape = guide_legend(title = "Individual", nrow = 1), fill = "none") +
  # Uncomment this line to turn off the legend
  # guides(color = "none", shape = "none", fill = "none") +
  # Specify the x and y-axis limits and breaks. Make sure that each label retains two decimal places even when there is a trailing zero
  scale_x_continuous(limits = c(-0.03, 0.42), breaks = seq(-0.03, 0.44, 0.09), labels = sprintf("%.2f", round(seq(-0.03, 0.44, 0.09), 2))) +
  scale_y_continuous(limits = c(-0.3, 0.4), breaks = seq(-0.3, 0.4, 0.1), labels = sprintf("%.2f", round(seq(-0.3, 0.4, 0.1), 2))) +
  theme_bw() +
  theme(
    legend.position = "top",
    legend.key.spacing = unit(0.2, "line"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 9),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_line(linewidth = 0.25),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 10),
    # margin() arguments: top, right, bottom, left
    plot.margin = margin(0, 3, -3, -3, unit = "pt"),
    legend.margin = margin(2, -3, -5, -3, unit = "pt")
  )

```

Save SPCC plot.
```{r eval = FALSE}

# Save this plot as an image file

# With legend
ggsave(filename = file.path(figures_path, "Fig_3", "Main_AcousticSpace_SPCC_IndividualIdentity_IndividualPolygons_legend.tiff"), width = 4, height = 2.6, units = "in", dpi = 300)

# Without legend
# This image size (and font sizes or other aesthetics above) should be iteratively updated to fit a composite figure of multiple acoustic space plots created in other software
ggsave(filename = file.path(figures_path, "Fig_3", "Main_AcousticSpace_SPCC_IndividualIdentity_IndividualPolygons.tiff"), width = 3.75, height = 2.6, units = "in", dpi = 300)

```